
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../accuracy_calculation/">
      
      
        <link rel="next" href="../logging_presets/">
      
      
      <link rel="icon" href="../imgs/Favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.1">
    
    
      
        <title>Inference Models - PyTorch Metric Learning</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.45e1311d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#inference-models" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PyTorch Metric Learning" class="md-header__button md-logo" aria-label="PyTorch Metric Learning" data-md-component="logo">
      
  <img src="../imgs/TinyLogo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyTorch Metric Learning
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Inference Models
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/KevinMusgrave/pytorch-metric-learning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    KevinMusgrave/pytorch-metric-learning
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PyTorch Metric Learning" class="md-nav__button md-logo" aria-label="PyTorch Metric Learning" data-md-component="logo">
      
  <img src="../imgs/TinyLogo.png" alt="logo">

    </a>
    PyTorch Metric Learning
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/KevinMusgrave/pytorch-metric-learning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    KevinMusgrave/pytorch-metric-learning
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../distances/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Distances
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../losses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Losses
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../miners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Miners
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../reducers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Reducers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../regularizers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Regularizers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../samplers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Samplers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../trainers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Trainers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../testers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Testers
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" checked>
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Utils
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            Utils
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../accuracy_calculation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Accuracy Calculation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Inference Models
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Inference Models
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#inferencemodel" class="md-nav__link">
    <span class="md-ellipsis">
      InferenceModel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matchfinder" class="md-nav__link">
    <span class="md-ellipsis">
      MatchFinder
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faissknn" class="md-nav__link">
    <span class="md-ellipsis">
      FaissKNN
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faisskmeans" class="md-nav__link">
    <span class="md-ellipsis">
      FaissKMeans
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customknn" class="md-nav__link">
    <span class="md-ellipsis">
      CustomKNN
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../logging_presets/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Logging Presets
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../common_functions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Common Functions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../distributed/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Distributed
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
        
          
          <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    How to extend this library
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            How to extend this library
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extend/losses/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom losses
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../extend/miners/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Custom miners
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Frequently Asked Questions
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#inferencemodel" class="md-nav__link">
    <span class="md-ellipsis">
      InferenceModel
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#matchfinder" class="md-nav__link">
    <span class="md-ellipsis">
      MatchFinder
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faissknn" class="md-nav__link">
    <span class="md-ellipsis">
      FaissKNN
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faisskmeans" class="md-nav__link">
    <span class="md-ellipsis">
      FaissKMeans
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#customknn" class="md-nav__link">
    <span class="md-ellipsis">
      CustomKNN
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="inference-models">Inference Models<a class="headerlink" href="#inference-models" title="Permanent link">&para;</a></h1>
<p>utils.inference contains classes that make it convenient to find matching pairs within a batch, or from a set of pairs. Take a look at <a href="https://colab.research.google.com/github/KevinMusgrave/pytorch-metric-learning/blob/master/examples/notebooks/Inference.ipynb">this notebook</a> to see example usage.</p>
<h2 id="inferencemodel">InferenceModel<a class="headerlink" href="#inferencemodel" title="Permanent link">&para;</a></h2>
<p><div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytorch_metric_learning.utils.inference</span> <span class="kn">import</span> <span class="n">InferenceModel</span>
<span class="n">InferenceModel</span><span class="p">(</span><span class="n">trunk</span><span class="p">,</span>
                <span class="n">embedder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">match_finder</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">knn_func</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">data_device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<strong>Parameters</strong>:</p>
<ul>
<li><strong>trunk</strong>: Your trained model for computing embeddings.</li>
<li><strong>embedder</strong>: Optional. This is if your model is split into two components (trunk and embedder). If None, then the embedder will simply return the trunk's output.</li>
<li><strong>match_finder</strong>: A <a href="./#matchfinder">MatchFinder</a> object. If <code>None</code>, it will be set to <code>MatchFinder(distance=CosineSimilarity(), threshold=0.9)</code>.</li>
<li><strong>normalize_embeddings</strong>: If True, embeddings will be normalized to have Euclidean norm of 1.</li>
<li><strong>knn_func</strong>: The function used for computing k-nearest-neighbors. If <code>None</code>, it will be set to <code>FaissKNN()</code>.</li>
<li><strong>data_device</strong>: The device that you want to put batches of data on. If not specified, GPUs will be used if available.</li>
<li><strong>dtype</strong>: The datatype to cast data to. If None, no casting will be done.</li>
</ul>
<p><strong>Methods</strong>:
<div class="highlight"><pre><span></span><code><span class="c1"># initialize with a model</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">InferenceModel</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

<span class="c1"># pass in a dataset to serve as the search space for k-nn</span>
<span class="n">im</span><span class="o">.</span><span class="n">train_knn</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

<span class="c1"># add another dataset to the index</span>
<span class="n">im</span><span class="o">.</span><span class="n">add_to_knn</span><span class="p">(</span><span class="n">dataset2</span><span class="p">)</span>

<span class="c1"># get the 10 nearest neighbors of a query</span>
<span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_nearest_neighbors</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># determine if inputs are close to each other</span>
<span class="n">is_match</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">is_match</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># determine &quot;is_match&quot; pairwise for all elements in a batch</span>
<span class="n">match_matrix</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">get_matches</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># save and load the knn function (which is a faiss index by default)</span>
<span class="n">im</span><span class="o">.</span><span class="n">save_knn_func</span><span class="p">(</span><span class="s2">&quot;filename.index&quot;</span><span class="p">)</span>
<span class="n">im</span><span class="o">.</span><span class="n">load_knn_func</span><span class="p">(</span><span class="s2">&quot;filename.index&quot;</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="matchfinder">MatchFinder<a class="headerlink" href="#matchfinder" title="Permanent link">&para;</a></h2>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytorch_metric_learning.utils.inference</span> <span class="kn">import</span> <span class="n">MatchFinder</span>
<span class="n">MatchFinder</span><span class="p">(</span><span class="n">distance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p><strong>Parameters</strong>:</p>
<ul>
<li><strong>distance</strong>: A <a href="../distances/">distance</a> object.</li>
<li><strong>threshold</strong>: Optional. Pairs will be a match if they fall under this threshold for non-inverted distances, or over this value for inverted distances. If not provided, then a threshold must be provided during function calls.</li>
</ul>
<h2 id="faissknn">FaissKNN<a class="headerlink" href="#faissknn" title="Permanent link">&para;</a></h2>
<p>Uses the faiss library to compute k-nearest-neighbors</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytorch_metric_learning.utils.inference</span> <span class="kn">import</span> <span class="n">FaissKNN</span>
<span class="n">FaissKNN</span><span class="p">(</span><span class="n">reset_before</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">reset_after</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">index_init_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">gpus</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p><strong>Parameters</strong>:</p>
<ul>
<li><strong>reset_before</strong>: Reset the faiss index before knn is computed.</li>
<li><strong>reset_after</strong>: Reset the faiss index after knn is computed (good for clearing memory).</li>
<li><strong>index_init_fn</strong>: A callable that takes in the embedding dimensionality and returns a faiss index. The default is <code>faiss.IndexFlatL2</code>.</li>
<li><strong>gpus</strong>: A list of gpu indices to move the faiss index onto. The default is to use all available gpus, if the input tensors are also on gpus.</li>
</ul>
<p>Example:
<div class="highlight"><pre><span></span><code><span class="c1"># use faiss.IndexFlatIP on 3 gpus</span>
<span class="n">knn_func</span> <span class="o">=</span> <span class="n">FaissKNN</span><span class="p">(</span><span class="n">index_init_fn</span><span class="o">=</span><span class="n">faiss</span><span class="o">.</span><span class="n">IndexFlatIP</span><span class="p">,</span> <span class="n">gpus</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>

<span class="c1"># query = query embeddings </span>
<span class="c1"># k = the k in k-nearest-neighbors</span>
<span class="c1"># reference = the embeddings to search</span>
<span class="c1"># last argument is whether or not query and reference share datapoints</span>
<span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">knn_func</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">references</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="faisskmeans">FaissKMeans<a class="headerlink" href="#faisskmeans" title="Permanent link">&para;</a></h2>
<p>Uses the faiss library to do k-means clustering.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytorch_metric_learning.utils.inference</span> <span class="kn">import</span> <span class="n">FaissKMeans</span>
<span class="n">FaissKMeans</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<p><strong>Parameters</strong>:</p>
<ul>
<li><strong>kwargs</strong>: Keyword arguments that will be passed to the <code>faiss.Kmeans</code> constructor.</li>
</ul>
<p>Example:
<div class="highlight"><pre><span></span><code><span class="n">kmeans_func</span> <span class="o">=</span> <span class="n">FaissKMeans</span><span class="p">(</span><span class="n">niter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gpu</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># cluster into 10 groups</span>
<span class="n">cluster_assignments</span> <span class="o">=</span> <span class="n">kmeans_func</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="customknn">CustomKNN<a class="headerlink" href="#customknn" title="Permanent link">&para;</a></h2>
<p>Uses a <a href="../distances/">distance function</a> to determine similarity between datapoints, and then computes k-nearest-neighbors.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytorch_metric_learning.utils.inference</span> <span class="kn">import</span> <span class="n">CustomKNN</span>
<span class="n">CustomKNN</span><span class="p">(</span><span class="n">distance</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</code></pre></div>
<p><strong>Parameters</strong>:</p>
<ul>
<li><strong>distance</strong>: A <a href="../distances/">distance function</a></li>
<li><strong>batch_size</strong>: If specified, k-nn will be computed incrementally. For example, if there are 50000 reference embeddings and the batch size is 32, then CustomKNN will iterate through all embeddings, using distance matrices of size (32, 50000). The final result is equal to the  <code>batch_size=None</code> setting, but saves memory because the full (50000, 50000) matrix does not need to be computed all at once.</li>
</ul>
<p>Example:
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytorch_metric_learning.distances</span> <span class="kn">import</span> <span class="n">SNRDistance</span>
<span class="kn">from</span> <span class="nn">pytorch_metric_learning.utils.inference</span> <span class="kn">import</span> <span class="n">CustomKNN</span>

<span class="n">knn_func</span> <span class="o">=</span> <span class="n">CustomKNN</span><span class="p">(</span><span class="n">SNRDistance</span><span class="p">())</span>
<span class="n">distances</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">knn_func</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">references</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</code></pre></div></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d7c377c4.min.js"></script>
      
    
  </body>
</html>

<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../imgs/Favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.3">
    
    
      
        <title>Testers - PyTorch Metric Learning</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4a0965b7.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#ef5552">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="red" data-md-color-accent="red">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#testers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="PyTorch Metric Learning" class="md-header__button md-logo" aria-label="PyTorch Metric Learning" data-md-component="logo">
      
  <img src="../imgs/TinyLogo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            PyTorch Metric Learning
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Testers
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/KevinMusgrave/pytorch-metric-learning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    KevinMusgrave/pytorch-metric-learning
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="PyTorch Metric Learning" class="md-nav__button md-logo" aria-label="PyTorch Metric Learning" data-md-component="logo">
      
  <img src="../imgs/TinyLogo.png" alt="logo">

    </a>
    PyTorch Metric Learning
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/KevinMusgrave/pytorch-metric-learning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    KevinMusgrave/pytorch-metric-learning
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../distances/" class="md-nav__link">
        Distances
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../losses/" class="md-nav__link">
        Losses
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../miners/" class="md-nav__link">
        Miners
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../reducers/" class="md-nav__link">
        Reducers
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../regularizers/" class="md-nav__link">
        Regularizers
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../samplers/" class="md-nav__link">
        Samplers
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../trainers/" class="md-nav__link">
        Trainers
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Testers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Testers
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#testing-splits" class="md-nav__link">
    Testing splits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basetester" class="md-nav__link">
    BaseTester
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#globalembeddingspacetester" class="md-nav__link">
    GlobalEmbeddingSpaceTester
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#withsameparentlabeltester" class="md-nav__link">
    WithSameParentLabelTester
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#globaltwostreamembeddingspacetester" class="md-nav__link">
    GlobalTwoStreamEmbeddingSpaceTester
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Utils
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Utils" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Utils
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../accuracy_calculation/" class="md-nav__link">
        Accuracy Calculation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../inference_models/" class="md-nav__link">
        Inference Models
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../logging_presets/" class="md-nav__link">
        Logging Presets
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../common_functions/" class="md-nav__link">
        Common Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../distributed/" class="md-nav__link">
        Distributed
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_11">
          How to extend this library
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="How to extend this library" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          How to extend this library
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extend/losses/" class="md-nav__link">
        Custom losses
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../extend/miners/" class="md-nav__link">
        Custom miners
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#testing-splits" class="md-nav__link">
    Testing splits
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#basetester" class="md-nav__link">
    BaseTester
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#globalembeddingspacetester" class="md-nav__link">
    GlobalEmbeddingSpaceTester
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#withsameparentlabeltester" class="md-nav__link">
    WithSameParentLabelTester
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#globaltwostreamembeddingspacetester" class="md-nav__link">
    GlobalTwoStreamEmbeddingSpaceTester
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/KevinMusgrave/pytorch-metric-learning/edit/master/docs/testers.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="testers">Testers<a class="headerlink" href="#testers" title="Permanent link">&para;</a></h1>
<p>Testers take your model and dataset, and compute nearest-neighbor based accuracy metrics. Note that the testers require the <a href="https://github.com/facebookresearch/faiss/blob/master/INSTALL.md">faiss package</a>, which you can install with conda.</p>
<p>In general, testers are used as follows:
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pytorch_metric_learning</span> <span class="kn">import</span> <span class="n">testers</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">testers</span><span class="o">.</span><span class="n">SomeTestingFunction</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">dataset_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="n">train_dataset</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">val_dataset</span><span class="p">}</span>
<span class="n">all_accuracies</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>

<span class="c1"># Or if your model is composed of a trunk + embedder</span>
<span class="n">all_accuracies</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test</span><span class="p">(</span><span class="n">dataset_dict</span><span class="p">,</span> <span class="n">epoch</span><span class="p">,</span> <span class="n">trunk</span><span class="p">,</span> <span class="n">embedder</span><span class="p">)</span>
</code></pre></div>
You can perform custom actions by writing an end-of-testing hook (see the documentation for <a href="#basetester">BaseTester</a>), and you can access the test results directly via the <code>all_accuracies</code> attribute:
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">end_of_testing_hook</span><span class="p">(</span><span class="n">tester</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">all_accuracies</span><span class="p">)</span>
</code></pre></div>
This will print out a dictionary of accuracy metrics, per dataset split. You'll see something like this:
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="s2">&quot;train&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AMI_level0&quot;</span><span class="p">:</span> <span class="mf">0.53</span><span class="p">,</span> <span class="o">...</span><span class="p">},</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;AMI_level0&quot;</span><span class="p">:</span> <span class="mf">0.44</span><span class="p">,</span> <span class="o">...</span><span class="p">}}</span>
</code></pre></div>
Each of the accuracy metric names is appended with <code>level0</code>, which refers to the 0th label hierarchy level (see the documentation for <a href="#basetester">BaseTester</a>). This is only relevant if you're dealing with multi-label datasets.</p>
<p>For an explanation of the default accuracy metrics, see the <a href="../accuracy_calculation/#explanations-of-the-default-accuracy-metrics">AccuracyCalculator documentation</a>.</p>
<h3 id="testing-splits">Testing splits<a class="headerlink" href="#testing-splits" title="Permanent link">&para;</a></h3>
<p>By default, every dataset in <code>dataset_dict</code> will be evaluated using itself as the query and reference (on which to find nearest neighbors).
More flexibility is allowed with the optional argument <code>splits_to_eval</code> taken by <code>tester.test()</code>.
<code>splits_to_eval</code> is a list of <code>(query_split, [list_of_reference_splits])</code> tuples.</p>
<p>For example, let's say your <code>dataset_dict</code> has two keys: <code>"dataset_a"</code> and <code>"train"</code>.</p>
<ul>
<li>The default <code>splits_to_eval = None</code> is equivalent to: 
<div class="highlight"><pre><span></span><code><span class="n">splits_to_eval</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;dataset_a&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dataset_a&#39;</span><span class="p">]),</span> <span class="p">(</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])]</span>
</code></pre></div></li>
<li><code>dataset_a</code> as the query, and <code>train</code> as the reference: 
<div class="highlight"><pre><span></span><code><span class="n">splits_to_eval</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;dataset_a&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">])]</span>
</code></pre></div></li>
<li><code>dataset_a</code> as the query, and <code>dataset_a</code> + <code>train</code> as the reference: 
<div class="highlight"><pre><span></span><code><span class="n">splits_to_eval</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;dataset_a&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;dataset_a&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">])]</span>
</code></pre></div></li>
</ul>
<h2 id="basetester">BaseTester<a class="headerlink" href="#basetester" title="Permanent link">&para;</a></h2>
<p>All trainers extend this class and therefore inherit its <code>__init__</code> arguments.
<div class="highlight"><pre><span></span><code><span class="n">testers</span><span class="o">.</span><span class="n">BaseTester</span><span class="p">(</span><span class="n">normalize_embeddings</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">use_trunk_output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                    <span class="n">dataloader_num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">pca</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">data_device</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">data_and_label_getter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">label_hierarchy_level</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="n">end_of_testing_hook</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">dataset_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">set_min_label_to_zero</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">accuracy_calculator</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">visualizer</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">visualizer_hook</span><span class="o">=</span><span class="kc">None</span><span class="p">,)</span>
</code></pre></div></p>
<p><strong>Parameters</strong>:</p>
<ul>
<li><strong>normalize_embeddings</strong>: If True, embeddings will be normalized to Euclidean norm of 1 before nearest neighbors are computed.</li>
<li><strong>use_trunk_output</strong>: If True, the output of the trunk_model will be used to compute nearest neighbors, i.e. the output of the embedder model will be ignored.</li>
<li><strong>batch_size</strong>: How many dataset samples to process at each iteration when computing embeddings.</li>
<li><strong>dataloader_num_workers</strong>: How many processes the dataloader will use.</li>
<li><strong>pca</strong>: The number of dimensions that your embeddings will be reduced to, using PCA. The default is None, meaning PCA will not be applied.</li>
<li><strong>data_device</strong>: Which gpu to use for the loaded dataset samples. If None, then the gpu or cpu will be used (whichever is available).</li>
<li><strong>dtype</strong>: The type that the dataset output will be converted to, e.g. <code>torch.float16</code>. If set to <code>None</code>, then no type casting will be done.</li>
<li><strong>data_and_label_getter</strong>: A function that takes the output of your dataset's <code>__getitem__</code> function, and returns a tuple of (data, labels). If None, then it is assumed that <code>__getitem__</code> returns (data, labels). </li>
<li><strong>label_hierarchy_level</strong>: If each sample in your dataset has multiple labels, then this integer argument can be used to select which "level" to use. This assumes that your labels are "2-dimensional" with shape (num_samples, num_hierarchy_levels). Leave this at the default value, 0, if your data does not have multiple labels per sample.</li>
<li><strong>end_of_testing_hook</strong>: This is an optional function that has one input argument (the tester object) and performs some action (e.g. logging data) at the end of testing.<ul>
<li>You'll probably want to access the accuracy metrics, which are stored in <code>tester.all_accuracies</code>. This is a nested dictionary with the following format: <code>tester.all_accuracies[split_name][metric_name] = metric_value</code></li>
<li>If you want ready-to-use hooks, take a look at the <a href="../logging_presets/">logging_presets module</a>.</li>
</ul>
</li>
<li><strong>dataset_labels</strong>: The labels for your dataset. Can be 1-dimensional (1 label per datapoint) or 2-dimensional, where each row represents a datapoint, and the columns are the multiple labels that the datapoint has. Labels can be integers or strings. <strong>This option needs to be specified only if <code>set_min_label_to_zero</code> is True.</strong></li>
<li><strong>set_min_label_to_zero</strong>: If True, labels will be mapped such that they represent their rank in the label set. For example, if your dataset has labels 5, 10, 12, 13, then at each iteration, these would become 0, 1, 2, 3. You should also set this to True if you want to use string labels. In that case, 'dog', 'cat', 'monkey' would get mapped to 1, 0, 2. If True, you must pass in <code>dataset_labels</code> (see above). The default is False.</li>
<li><strong>accuracy_calculator</strong>: Optional. An object that extends <a href="../accuracy_calculation/">AccuracyCalculator</a>. This will be used to compute the accuracy of your model. By default, AccuracyCalculator is used.</li>
<li><strong>visualizer</strong>: Optional. An object that has implemented the <code>fit_transform</code> method, as done by <a href="https://github.com/lmcinnes/umap">UMAP</a> and many scikit-learn functions. For example, you can set <code>visualizer = umap.UMAP()</code>. The object's <code>fit_transform</code> function should take in a 2D array of embeddings, and reduce the dimensionality, such that calling <code>visualizer.fit_transform(embeddings)</code> results in a 2D array of size (N, 2).</li>
<li><strong>visualizer_hook</strong>: Optional. This function will be passed the following args. You can do whatever you want in this function, but the reason it exists is to allow you to save a plot of the embeddings etc.<ul>
<li>visualizer: The visualizer object that you passed in.</li>
<li>embeddings: The dimensionality reduced embeddings.</li>
<li>label: The corresponding labels for each embedding.</li>
<li>split_name: The name of the split (train, val, etc.)</li>
<li>keyname: The name of the dictionary key where the embeddings and labels are stored.</li>
<li>epoch: The epoch for which the embeddings are being computed.</li>
</ul>
</li>
</ul>
<p><strong>Functions</strong>:</p>
<ul>
<li><code>tester.test</code></li>
</ul>
<p>Call this to test your model on a dataset dict. It returns a dictionary of accuracies.</p>
<div class="highlight"><pre><span></span><code><span class="n">all_accuracies</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">test</span><span class="p">(</span>
    <span class="n">dataset_dict</span><span class="p">,</span> <span class="c1"># dictionary mapping strings to datasets</span>
    <span class="n">epoch</span><span class="p">,</span> <span class="c1"># used for logging</span>
    <span class="n">trunk_model</span><span class="p">,</span> <span class="c1"># your model</span>
    <span class="n">embedder_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># by default this will be a no-op</span>
    <span class="n">splits_to_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="kc">None</span> <span class="c1"># custom collate_fn for the dataloader</span>
<span class="p">)</span>
</code></pre></div>
<ul>
<li><code>tester.get_all_embeddings</code></li>
</ul>
<p>Returns all the embeddings and labels for the input dataset and model.</p>
<div class="highlight"><pre><span></span><code><span class="n">embeddings</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">get_all_embeddings</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">,</span> <span class="c1"># Any pytorch dataset</span>
    <span class="n">trunk_model</span><span class="p">,</span> <span class="c1"># your model</span>
    <span class="n">embedder_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># by default this will be a no-op</span>
    <span class="n">collate_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># custom collate_fn for the dataloader</span>
    <span class="nb">eval</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="c1"># set models to eval mode</span>
    <span class="n">return_as_numpy</span><span class="o">=</span><span class="kc">False</span>
 <span class="p">)</span>
</code></pre></div>
<h2 id="globalembeddingspacetester">GlobalEmbeddingSpaceTester<a class="headerlink" href="#globalembeddingspacetester" title="Permanent link">&para;</a></h2>
<p>Computes nearest neighbors by looking at all points in the embedding space (rather than a subset). This is probably the tester you are looking for. To see it in action, check one of the <a href="https://github.com/KevinMusgrave/pytorch-metric-learning/tree/master/examples">example notebooks</a>
<div class="highlight"><pre><span></span><code><span class="n">testers</span><span class="o">.</span><span class="n">GlobalEmbeddingSpaceTester</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="withsameparentlabeltester">WithSameParentLabelTester<a class="headerlink" href="#withsameparentlabeltester" title="Permanent link">&para;</a></h2>
<p>This assumes there is a label hierarchy. For each sample, the search space is narrowed by only looking at sibling samples, i.e. samples with the same parent label. For example, consider a dataset with 4 fine-grained classes {cat, dog, car, truck}, and 2 coarse-grained classes {animal, vehicle}. The nearest neighbor search for cats and dogs will consist of animals, and the nearest-neighbor search for cars and trucks will consist of vehicles.
<div class="highlight"><pre><span></span><code><span class="n">testers</span><span class="o">.</span><span class="n">WithSameParentLabelTester</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></p>
<h2 id="globaltwostreamembeddingspacetester">GlobalTwoStreamEmbeddingSpaceTester<a class="headerlink" href="#globaltwostreamembeddingspacetester" title="Permanent link">&para;</a></h2>
<p>This is the corresponding tester for <a href="../trainers/#twostreammetricloss">TwoStreamMetricLoss</a>. The supplied <strong>dataset</strong> must return <code>(anchor, positive, label)</code>.
<div class="highlight"><pre><span></span><code><span class="n">testers</span><span class="o">.</span><span class="n">GlobalTwoStreamEmbeddingSpaceTester</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div>
<strong>Requirements</strong>:</p>
<p>This tester only supports the default value for <code>splits_to_eval</code>: each split is used for both query and reference</p>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../trainers/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Trainers" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Trainers
            </div>
          </div>
        </a>
      
      
        
        <a href="../accuracy_calculation/" class="md-footer__link md-footer__link--next" aria-label="Next: Accuracy Calculation" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Accuracy Calculation
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b028fd86.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.f758a944.min.js"></script>
      
    
  </body>
</html>